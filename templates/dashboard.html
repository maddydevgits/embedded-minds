{% extends "base.html" %}

{% block title %}Dashboard - Smart Comb{% endblock %}

{% block content %}
<div class="flex-1 bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl sm:text-2xl font-bold text-indigo-600">Smart Comb</h1>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span class="text-gray-700 text-sm sm:text-base hidden sm:inline">Welcome, {{ session.username }}</span>
                    <span class="text-gray-700 text-sm sm:hidden">{{ session.username }}</span>
                    <a href="{{ url_for('logout') }}" class="text-indigo-600 hover:text-indigo-800 text-sm sm:text-base px-2 sm:px-0">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Vibration Motor Control -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Vibration Motor Control</h2>
            
            <!-- Intensity Control -->
            <div class="mb-4 p-4 bg-indigo-50 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-medium text-gray-700">Intensity</label>
                    <div class="flex items-center gap-2">
                        <span id="intensityValue" class="text-sm font-semibold text-indigo-600">50%</span>
                        <button onclick="getRecommendedIntensity()" class="text-xs px-2 py-1 bg-indigo-200 hover:bg-indigo-300 text-indigo-700 rounded transition">
                            Auto
                        </button>
                    </div>
                </div>
                <input type="range" id="intensitySlider" min="0" max="255" value="128" 
                       oninput="updateIntensityDisplay(this.value)"
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Low (0)</span>
                    <span>Medium (128)</span>
                    <span>High (255)</span>
                </div>
                <p id="intensityRecommendation" class="text-xs text-gray-600 mt-2"></p>
            </div>
            
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
                <button id="vibrationBtn" onclick="toggleVibration()" 
                        class="px-6 sm:px-8 py-3 sm:py-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-semibold text-base sm:text-lg w-full sm:w-auto">
                    <span id="vibrationStatus">OFF</span>
                </button>
                <p id="vibrationStatusText" class="text-gray-600 text-sm sm:text-base">Motor is currently OFF</p>
            </div>
        </div>

        <!-- User Selection -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Who is combing?</h2>
                <button onclick="openAgeConfig()" class="px-3 sm:px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition text-sm sm:text-base flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Configure Ages
                </button>
            </div>
            <div class="flex flex-wrap gap-2 sm:gap-4">
                <button onclick="selectUser('mother')" class="user-btn flex-1 sm:flex-none px-4 sm:px-6 py-2 sm:py-3 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition font-medium text-sm sm:text-base">
                    Mother
                </button>
                <button onclick="selectUser('father')" class="user-btn flex-1 sm:flex-none px-4 sm:px-6 py-2 sm:py-3 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition font-medium text-sm sm:text-base">
                    Father
                </button>
                <button onclick="selectUser('child')" class="user-btn flex-1 sm:flex-none px-4 sm:px-6 py-2 sm:py-3 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition font-medium text-sm sm:text-base">
                    Child
                </button>
            </div>
            <div class="mt-4 space-y-2">
                <p id="selectedUser" class="text-gray-600 text-sm sm:text-base"></p>
                <div id="roleStatus" class="text-xs sm:text-sm"></div>
                <div class="text-xs sm:text-sm text-gray-500">
                    <p class="break-all">Your User ID for MQTT: <span id="userIdDisplay" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded break-all"></span></p>
                    <p class="text-xs mt-1">Update this in your ESP32 code</p>
                    <button onclick="checkDebugData()" class="mt-2 text-xs px-3 py-1.5 bg-gray-200 hover:bg-gray-300 rounded text-gray-700">
                        Debug: Check Database
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <!-- Sensor Data Visualization -->
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Sensor Data</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Range</label>
                    <select id="timeRange" onchange="loadSensorData()" class="w-full sm:w-auto border border-gray-300 rounded-lg px-4 py-2 text-sm sm:text-base">
                        <option value="100">Last 100 readings</option>
                        <option value="50">Last 50 readings</option>
                        <option value="20">Last 20 readings</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <canvas id="sensorChart" height="250" class="max-w-full"></canvas>
                </div>
            </div>

            <!-- Current Sensor Readings -->
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Current Readings</h2>
                
                <!-- Hair Health Status -->
                <div class="mb-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 font-semibold text-sm sm:text-base">Hair Health</span>
                        <span id="healthStatus" class="px-3 py-1 rounded-full text-xs sm:text-sm font-bold">--</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-4 sm:h-5 overflow-hidden">
                            <div id="healthBar" class="h-full transition-all duration-500 rounded-full" style="width: 0%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 25%, #10b981 50%, #3b82f6 75%, #8b5cf6 100%);"></div>
                        </div>
                        <span id="healthPercentage" class="text-xl sm:text-2xl font-bold text-indigo-600 min-w-[60px] text-right">--%</span>
                    </div>
                    <p id="healthMessage" class="text-xs sm:text-sm text-gray-600 mt-2"></p>
                </div>
                
                <div class="space-y-3 sm:space-y-4">
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium text-sm sm:text-base">Temperature</span>
                            <span id="tempValue" class="text-xl sm:text-2xl font-bold text-blue-600">--°C</span>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-3 sm:p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium text-sm sm:text-base">Light (Density)</span>
                            <span id="lightValue" class="text-xl sm:text-2xl font-bold text-yellow-600">--</span>
                        </div>
                    </div>
                    <div class="bg-green-50 p-3 sm:p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium text-sm sm:text-base">Moisture</span>
                            <span id="moistureValue" class="text-xl sm:text-2xl font-bold text-green-600">--</span>
                        </div>
                        <p id="moistureStatus" class="text-xs sm:text-sm text-gray-600 mt-2"></p>
                    </div>
                    <div class="bg-purple-50 p-3 sm:p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium text-sm sm:text-base">Combing Status</span>
                            <span id="combingStatus" class="text-base sm:text-lg font-semibold text-purple-600">Inactive</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mt-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-0 mb-4">
                <div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Product Recommendations</h2>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1">Click Amazon links to search for recommended products</p>
                </div>
                <button onclick="getRecommendations()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm sm:text-base w-full sm:w-auto">
                    Get Recommendations
                </button>
            </div>
            <div id="recommendations" class="mt-4">
                <p class="text-gray-500">Select a user and click "Get Recommendations" to see personalized product suggestions.</p>
            </div>
        </div>

        <!-- Chatbot -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mt-6">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Hair Health Assistant</h2>
            <div class="border border-gray-200 rounded-lg p-3 sm:p-4 h-48 sm:h-64 overflow-y-auto mb-4 bg-gray-50" id="chatMessages">
                <div class="text-gray-500 text-xs sm:text-sm">Ask me anything about hair health, monitoring, or the smart comb system!</div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-2">
                <div class="flex-1 flex items-center gap-2">
                    <input type="text" id="chatInput" placeholder="Type your question or click mic to speak..." 
                           class="flex-1 border border-gray-300 rounded-lg px-3 sm:px-4 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="micButton" onclick="toggleVoiceInput()" 
                            class="p-2 sm:p-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg transition flex-shrink-0">
                        <svg id="micIcon" class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                </div>
                <button onclick="sendMessage()" class="px-4 sm:px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm sm:text-base w-full sm:w-auto">
                    Send
                </button>
            </div>
            <div id="voiceStatus" class="mt-2 text-xs sm:text-sm text-gray-500 hidden"></div>
        </div>
    </div>
</div>

<!-- Age Configuration Modal -->
<div id="ageConfigModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 sm:w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Configure Ages</h3>
                <button onclick="closeAgeConfig()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mother's Age</label>
                    <input type="number" id="motherAge" min="1" max="120" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Father's Age</label>
                    <input type="number" id="fatherAge" min="1" max="120" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Child's Age</label>
                    <input type="number" id="childAge" min="1" max="120" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveAges()" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save
                </button>
                <button onclick="closeAgeConfig()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedRole = null;
let sensorChart = null;
let chartData = { labels: [], temperature: [], light: [], moisture: [] };

function selectUser(role) {
    selectedRole = role;
    document.querySelectorAll('.user-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white');
        btn.classList.add('bg-indigo-100', 'text-indigo-700');
    });
    event.target.classList.remove('bg-indigo-100', 'text-indigo-700');
    event.target.classList.add('bg-indigo-600', 'text-white');
    document.getElementById('selectedUser').textContent = `Selected: ${role.charAt(0).toUpperCase() + role.slice(1)}`;
    
    // Get recommended intensity for this role
    getRecommendedIntensity();
    
    // Update status
    const statusDiv = document.getElementById('roleStatus');
    statusDiv.innerHTML = '<span class="text-yellow-600">Sending role to device...</span>';
    
    // Send role to ESP32 device via MQTT
    fetch('/api/set-role', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role: role })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log('Role sent to device:', data.role);
            statusDiv.innerHTML = `<span class="text-green-600">✓ Role "${role}" sent to device. Waiting for sensor data...</span>`;
            // Wait a moment for ESP32 to update, then load data
            setTimeout(() => {
                loadSensorData();
            }, 1000);
        } else {
            console.error('Failed to send role:', data.error);
            statusDiv.innerHTML = `<span class="text-red-600">✗ Failed to send role: ${data.error}</span>`;
            loadSensorData(); // Still try to load existing data
        }
    })
    .catch(err => {
        console.error('Error sending role to device:', err);
        statusDiv.innerHTML = `<span class="text-red-600">✗ Error: ${err.message}</span>`;
        loadSensorData(); // Still try to load existing data
    });
}

function loadSensorData() {
    if (!selectedRole) {
        alert('Please select a user first');
        return;
    }
    
    const limit = document.getElementById('timeRange').value;
    const url = `/api/sensor-data?role=${selectedRole}&limit=${limit}`;
    console.log('Loading sensor data from:', url);
    
    fetch(url)
        .then(res => {
            console.log('Response status:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Sensor data received:', data);
            console.log('Data length:', data.length);
            console.log('Selected role:', selectedRole);
            
            if (data && data.length > 0) {
                // Check if data has the correct role
                const firstDataRole = data[0].role;
                console.log('First data item role:', firstDataRole);
                
                if (firstDataRole !== selectedRole) {
                    console.warn(`Warning: Data role "${firstDataRole}" doesn't match selected role "${selectedRole}"`);
                }
                
                updateChart(data);
                updateCurrentReadings(data[0]);
                
                // Remove any "no data" messages
                const chartContainer = document.getElementById('sensorChart').parentElement;
                const noDataMsg = chartContainer.querySelector('.no-data-msg');
                if (noDataMsg) {
                    noDataMsg.remove();
                }
            } else {
                console.warn('No sensor data found for role:', selectedRole);
                // Show message to user
                const chartContainer = document.getElementById('sensorChart').parentElement;
                const existingMsg = chartContainer.querySelector('.no-data-msg');
                if (!existingMsg) {
                    const msg = document.createElement('p');
                    msg.className = 'no-data-msg text-gray-500 text-center mt-4 p-4 bg-yellow-50 rounded-lg';
                    msg.innerHTML = `
                        <p class="font-semibold">No sensor data found for "${selectedRole}"</p>
                        <p class="text-sm mt-2">Possible reasons:</p>
                        <ul class="text-sm mt-1 list-disc list-inside">
                            <li>ESP32 hasn't received the role update yet</li>
                            <li>ESP32 is not connected or publishing data</li>
                            <li>No combing detected (IR sensor not triggered)</li>
                            <li>User ID mismatch between ESP32 and dashboard</li>
                        </ul>
                        <p class="text-xs mt-2 text-gray-400">Check Serial Monitor on ESP32 to verify role was received</p>
                    `;
                    chartContainer.appendChild(msg);
                }
            }
        })
        .catch(err => {
            console.error('Error loading sensor data:', err);
            const chartContainer = document.getElementById('sensorChart').parentElement;
            const errorMsg = document.createElement('p');
            errorMsg.className = 'no-data-msg text-red-600 text-center mt-4 p-4 bg-red-50 rounded-lg';
            errorMsg.textContent = `Error loading sensor data: ${err.message}`;
            chartContainer.appendChild(errorMsg);
        });
}

function updateChart(data) {
    if (!data || data.length === 0) {
        console.warn('No data to display in chart');
        return;
    }
    
    // Remove any existing "no data" message
    const chartContainer = document.getElementById('sensorChart').parentElement;
    const noDataMsg = chartContainer.querySelector('.no-data-msg');
    if (noDataMsg) {
        noDataMsg.remove();
    }
    
    chartData.labels = data.map(d => {
        try {
            return new Date(d.timestamp).toLocaleTimeString();
        } catch (e) {
            return d.timestamp || 'N/A';
        }
    }).reverse();
    chartData.temperature = data.map(d => parseFloat(d.temperature) || 0).reverse();
    chartData.light = data.map(d => parseFloat(d.light) || 0).reverse();
    chartData.moisture = data.map(d => parseFloat(d.moisture) || 0).reverse();

    const ctx = document.getElementById('sensorChart').getContext('2d');
    
    if (sensorChart) {
        sensorChart.destroy();
    }
    
    sensorChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Temperature (°C)',
                    data: chartData.temperature,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Light (Density)',
                    data: chartData.light,
                    borderColor: 'rgb(234, 179, 8)',
                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Moisture (%)',
                    data: chartData.moisture,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: window.innerWidth < 640 ? 1.5 : 2,
            plugins: {
                legend: {
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: window.innerWidth < 640 ? 10 : 12
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            size: window.innerWidth < 640 ? 10 : 12
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: window.innerWidth < 640 ? 10 : 12
                        },
                        maxRotation: window.innerWidth < 640 ? 45 : 0,
                        minRotation: window.innerWidth < 640 ? 45 : 0
                    }
                }
            }
        }
    });
}

// Calculate hair health percentage and status
function calculateHairHealth(data) {
    if (!data || !data.temperature || !data.light || !data.moisture) {
        return { percentage: 0, status: '--', message: 'No data available' };
    }
    
    const temp = parseFloat(data.temperature) || 0;
    const light = parseFloat(data.light) || 0;
    const moisture = parseFloat(data.moisture) || 0;
    const moistureStatus = data.moisture_status || 'normal';
    
    // Normalize values to 0-100 scale
    // Temperature: Optimal range 20-30°C (score 0-100)
    let tempScore = 100;
    if (temp < 20) {
        tempScore = Math.max(0, 100 - (20 - temp) * 5); // Penalize cold
    } else if (temp > 30) {
        tempScore = Math.max(0, 100 - (temp - 30) * 5); // Penalize hot
    } else {
        // Optimal range: 22-28°C gets full score
        if (temp >= 22 && temp <= 28) {
            tempScore = 100;
        } else {
            tempScore = 100 - Math.abs(temp - 25) * 10;
        }
    }
    
    // Light (Density): Higher is generally better, but normalize
    // Assuming range 0-1000, optimal around 400-700
    let lightScore = 0;
    if (light > 0) {
        if (light >= 400 && light <= 700) {
            lightScore = 100; // Optimal density
        } else if (light < 400) {
            lightScore = (light / 400) * 80; // Lower density, lower score
        } else {
            lightScore = Math.max(60, 100 - ((light - 700) / 300) * 40); // Very dense might be too much
        }
    }
    
    // Moisture: Optimal is normal (40-60%), dry or oily is bad
    let moistureScore = 0;
    if (moistureStatus === 'normal') {
        if (moisture >= 40 && moisture <= 60) {
            moistureScore = 100; // Perfect
        } else if (moisture >= 30 && moisture < 40) {
            moistureScore = 80 - ((40 - moisture) * 2); // Slightly dry
        } else if (moisture > 60 && moisture <= 70) {
            moistureScore = 80 - ((moisture - 60) * 2); // Slightly oily
        } else {
            moistureScore = 60; // Still normal range but not optimal
        }
    } else if (moistureStatus === 'dry') {
        moistureScore = Math.max(20, 60 - (30 - moisture) * 2); // Dry is bad
    } else if (moistureStatus === 'oily') {
        moistureScore = Math.max(20, 60 - (moisture - 70) * 2); // Oily is bad
    }
    
    // Weighted average: Temperature 30%, Light 30%, Moisture 40%
    const healthPercentage = Math.round(
        (tempScore * 0.3) + (lightScore * 0.3) + (moistureScore * 0.4)
    );
    
    // Determine status
    let status, statusClass, message;
    if (healthPercentage >= 80) {
        status = 'Excellent';
        statusClass = 'bg-green-500 text-white';
        message = 'Your hair is in excellent condition!';
    } else if (healthPercentage >= 60) {
        status = 'Good';
        statusClass = 'bg-blue-500 text-white';
        message = 'Your hair health is good. Keep up the care!';
    } else if (healthPercentage >= 40) {
        status = 'Average';
        statusClass = 'bg-yellow-500 text-white';
        message = 'Hair health is average. Consider improving your hair care routine.';
    } else {
        status = 'Worst';
        statusClass = 'bg-red-500 text-white';
        message = 'Hair health needs immediate attention. Check recommendations for improvement.';
    }
    
    return {
        percentage: healthPercentage,
        status: status,
        statusClass: statusClass,
        message: message,
        scores: {
            temperature: Math.round(tempScore),
            light: Math.round(lightScore),
            moisture: Math.round(moistureScore)
        }
    };
}

function updateHairHealth(data) {
    const health = calculateHairHealth(data);
    
    // Update health bar
    const healthBar = document.getElementById('healthBar');
    const healthPercentage = document.getElementById('healthPercentage');
    const healthStatus = document.getElementById('healthStatus');
    const healthMessage = document.getElementById('healthMessage');
    
    healthBar.style.width = health.percentage + '%';
    healthPercentage.textContent = health.percentage + '%';
    healthStatus.textContent = health.status;
    healthStatus.className = `px-3 py-1 rounded-full text-xs sm:text-sm font-bold ${health.statusClass}`;
    healthMessage.textContent = health.message;
}

function updateCurrentReadings(data) {
    document.getElementById('tempValue').textContent = `${(data.temperature || 0).toFixed(1)}°C`;
    document.getElementById('lightValue').textContent = (data.light || 0).toFixed(0);
    document.getElementById('moistureValue').textContent = `${(data.moisture || 0).toFixed(1)}%`;
    document.getElementById('moistureStatus').textContent = `Status: ${data.moisture_status || 'normal'}`;
    document.getElementById('combingStatus').textContent = data.ir_sensor ? 'Active' : 'Inactive';
    
    // Update hair health
    updateHairHealth(data);
}

function getRecommendations() {
    if (!selectedRole) {
        alert('Please select a user first');
        return;
    }
    
    const recommendationsDiv = document.getElementById('recommendations');
    recommendationsDiv.innerHTML = '<p class="text-gray-500">Loading recommendations...</p>';
    
    fetch('/api/recommendations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role: selectedRole })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            recommendationsDiv.innerHTML = `<p class="text-red-600">${data.error}</p>`;
            return;
        }
        
        let html = '';
        if (data.recommendations && Array.isArray(data.recommendations)) {
            html = '<div class="space-y-3">';
            data.recommendations.forEach(rec => {
                if (typeof rec === 'string') {
                    // Try to extract product name from string
                    const productName = rec.replace(/^[-•]\s*/, '').split(/[:\n]/)[0].trim();
                    const amazonUrl = generateAmazonSearchUrl(productName);
                    html += `<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <p class="text-gray-800 mb-2">${rec}</p>
                        <a href="${amazonUrl}" target="_blank" rel="noopener noreferrer" 
                           class="inline-flex items-center px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2L3 7v11h4v-6h6v6h4V7l-7-5z"/>
                            </svg>
                            Search on Amazon
                        </a>
                    </div>`;
                } else if (rec.name) {
                    const productName = rec.name;
                    const amazonUrl = generateAmazonSearchUrl(productName);
                    html += `<div class="bg-indigo-50 p-3 sm:p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-semibold text-indigo-800 mb-1 text-sm sm:text-base">${rec.name}</h3>
                        ${rec.type ? `<p class="text-xs text-indigo-600 mb-2">${rec.type}</p>` : ''}
                        <p class="text-xs sm:text-sm text-gray-600 mb-3">${rec.reason || ''}</p>
                        ${rec.key_ingredients && rec.key_ingredients.length > 0 ? `
                        <div class="mb-3">
                            <p class="text-xs font-semibold text-gray-700 mb-1">Key Ingredients:</p>
                            <div class="flex flex-wrap gap-1.5">
                                ${rec.key_ingredients.map(ing => 
                                    `<span class="px-2 py-1 bg-white border border-indigo-200 text-indigo-700 text-xs rounded-full font-medium">${ing}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <a href="${amazonUrl}" target="_blank" rel="noopener noreferrer" 
                           class="inline-flex items-center justify-center px-3 sm:px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-xs sm:text-sm font-semibold rounded-lg transition shadow-sm hover:shadow w-full sm:w-auto">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2L3 7v11h4v-6h6v6h4V7l-7-5z"/>
                            </svg>
                            <span class="hidden sm:inline">Search "${productName}" on Amazon</span>
                            <span class="sm:hidden">Search on Amazon</span>
                        </a>
                    </div>`;
                }
            });
            html += '</div>';
        } else if (data.recommendations) {
            html = `<div class="bg-indigo-50 p-4 rounded-lg"><pre class="whitespace-pre-wrap text-gray-800">${data.recommendations}</pre></div>`;
        }
        
        // Display beneficial ingredients section
        if (data.beneficial_ingredients && Array.isArray(data.beneficial_ingredients) && data.beneficial_ingredients.length > 0) {
            html += '<div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200">';
            html += '<h3 class="font-semibold text-green-800 mb-3 text-base sm:text-lg flex items-center gap-2">';
            html += '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
            html += '</svg>';
            html += 'Beneficial Ingredients & Chemicals';
            html += '</h3>';
            html += '<div class="space-y-3">';
            data.beneficial_ingredients.forEach(ing => {
                html += `<div class="bg-white p-3 sm:p-4 rounded-lg border border-green-100 shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-2">
                        <h4 class="font-semibold text-green-800 text-sm sm:text-base">${ing.name || 'Unknown'}</h4>
                        ${ing.found_in ? `<span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">${ing.found_in}</span>` : ''}
                    </div>
                    ${ing.benefit ? `<p class="text-xs sm:text-sm text-gray-700">${ing.benefit}</p>` : ''}
                </div>`;
            });
            html += '</div>';
            html += '</div>';
        }
        
        if (data.tips && Array.isArray(data.tips)) {
            html += '<h3 class="font-semibold mt-4 mb-2">Tips:</h3><ul class="list-disc list-inside space-y-1">';
            data.tips.forEach(tip => {
                html += `<li class="text-gray-700">${tip}</li>`;
            });
            html += '</ul>';
        }
        
        recommendationsDiv.innerHTML = html || '<p class="text-gray-500">No recommendations available</p>';
    })
    .catch(err => {
        recommendationsDiv.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
    });
}

// Voice recognition and text-to-speech
let recognition = null;
let isListening = false;
let synth = window.speechSynthesis;

// Initialize speech recognition
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onstart = () => {
            isListening = true;
            updateMicButton(true);
            updateVoiceStatus('Listening... Speak now', 'text-green-600');
        };
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('chatInput').value = transcript;
            updateVoiceStatus('Voice input received ✓', 'text-green-600');
            setTimeout(() => {
                updateVoiceStatus('');
            }, 2000);
        };
        
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            updateMicButton(false);
            
            let errorMessage = '';
            let errorClass = 'text-red-600';
            
            switch(event.error) {
                case 'not-allowed':
                    errorMessage = 'Microphone permission denied. Please allow microphone access in your browser settings and try again.';
                    break;
                case 'no-speech':
                    errorMessage = 'No speech detected. Please try again.';
                    break;
                case 'audio-capture':
                    errorMessage = 'No microphone found. Please check your microphone connection.';
                    break;
                case 'network':
                    errorMessage = 'Network error. Please check your internet connection.';
                    break;
                case 'aborted':
                    errorMessage = 'Voice recognition aborted.';
                    break;
                default:
                    errorMessage = `Error: ${event.error}. Please try again.`;
            }
            
            updateVoiceStatus(errorMessage, errorClass);
            
            // Clear error message after 5 seconds
            setTimeout(() => {
                updateVoiceStatus('');
            }, 5000);
        };
        
        recognition.onend = () => {
            isListening = false;
            updateMicButton(false);
            // Don't clear status if there was an error
            const statusDiv = document.getElementById('voiceStatus');
            if (!statusDiv.classList.contains('text-red-600')) {
                updateVoiceStatus('');
            }
        };
    } else {
        console.warn('Speech recognition not supported');
        updateVoiceStatus('Voice input not supported in this browser', 'text-yellow-600');
    }
}

async function toggleVoiceInput() {
    if (!recognition) {
        initSpeechRecognition();
        if (!recognition) return;
    }
    
    if (isListening) {
        recognition.stop();
        return;
    }
    
    // Request microphone permission first
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Permission granted, stop the stream and start recognition
        stream.getTracks().forEach(track => track.stop());
        
        try {
            recognition.start();
        } catch (err) {
            console.error('Error starting recognition:', err);
            if (err.name === 'InvalidStateError') {
                updateVoiceStatus('Voice recognition is already running', 'text-yellow-600');
            } else {
                updateVoiceStatus('Error starting voice input: ' + err.message, 'text-red-600');
            }
        }
    } catch (err) {
        console.error('Microphone permission error:', err);
        let errorMsg = 'Microphone access denied. ';
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMsg += 'Please click the microphone icon in your browser\'s address bar and allow microphone access, then try again.';
        } else if (err.name === 'NotFoundError') {
            errorMsg += 'No microphone found. Please connect a microphone and try again.';
        } else {
            errorMsg += 'Please check your browser settings and allow microphone access.';
        }
        updateVoiceStatus(errorMsg, 'text-red-600');
        setTimeout(() => {
            updateVoiceStatus('');
        }, 8000);
    }
}

function updateMicButton(listening) {
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    
    if (listening) {
        micButton.classList.remove('bg-gray-200');
        micButton.classList.add('bg-red-500', 'animate-pulse');
        micIcon.classList.remove('text-gray-700');
        micIcon.classList.add('text-white');
    } else {
        micButton.classList.remove('bg-red-500', 'animate-pulse');
        micButton.classList.add('bg-gray-200');
        micIcon.classList.remove('text-white');
        micIcon.classList.add('text-gray-700');
    }
}

function updateVoiceStatus(message, textClass = 'text-gray-500') {
    const statusDiv = document.getElementById('voiceStatus');
    if (message) {
        statusDiv.textContent = message;
        statusDiv.className = `mt-2 text-xs sm:text-sm ${textClass}`;
        statusDiv.classList.remove('hidden');
    } else {
        statusDiv.classList.add('hidden');
    }
}

function speakText(text) {
    if (synth.speaking) {
        synth.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    utterance.onstart = () => {
        console.log('Speaking started');
    };
    
    utterance.onend = () => {
        console.log('Speaking ended');
    };
    
    utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event);
    };
    
    synth.speak(utterance);
}


function stopSpeaking() {
    if (synth.speaking) {
        synth.cancel();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    
    // Stop any ongoing speech
    stopSpeaking();
    
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML += `<div class="mb-2 text-right"><span class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-lg">${message}</span></div>`;
    input.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message })
    })
    .then(res => res.json())
    .then(data => {
        const responseId = 'response-' + Date.now();
        const responseDiv = document.createElement('div');
        responseDiv.className = 'mb-2';
        responseDiv.id = responseId;
        
        // Create text node for safe text display
        const textSpan = document.createElement('span');
        textSpan.className = 'inline-block bg-gray-200 text-gray-800 px-4 py-2 rounded-lg flex-1';
        textSpan.textContent = data.response;
        
        // Create speaker button
        const button = document.createElement('button');
        button.onclick = () => speakText(data.response);
        button.className = 'p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition flex-shrink-0';
        button.title = 'Speak response';
        button.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
            </svg>
        `;
        
        // Create container
        const container = document.createElement('div');
        container.className = 'flex items-start gap-2';
        container.appendChild(textSpan);
        container.appendChild(button);
        
        responseDiv.appendChild(container);
        chatMessages.appendChild(responseDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(err => {
        chatMessages.innerHTML += `<div class="mb-2"><span class="inline-block bg-red-100 text-red-800 px-4 py-2 rounded-lg">Error: ${err.message}</span></div>`;
    });
}

document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Initialize speech recognition on page load
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    initSpeechRecognition();
} else {
    document.getElementById('micButton').style.display = 'none';
    console.warn('Speech recognition not supported in this browser');
}

// Vibration motor state
let vibrationMotorState = false;
let currentIntensity = 128; // Default intensity (50%)

// Update intensity display
function updateIntensityDisplay(value) {
    currentIntensity = parseInt(value);
    const percent = Math.round((currentIntensity / 255) * 100);
    document.getElementById('intensityValue').textContent = percent + '%';
}

// Get recommended intensity based on role and age
function getRecommendedIntensity() {
    if (!selectedRole) {
        alert('Please select a role (Mother/Father/Child) first');
        return;
    }
    
    fetch(`/api/recommend-intensity?role=${selectedRole}`)
        .then(res => res.json())
        .then(data => {
            if (data.intensity !== undefined) {
                currentIntensity = data.intensity;
                document.getElementById('intensitySlider').value = data.intensity;
                updateIntensityDisplay(data.intensity);
                document.getElementById('intensityRecommendation').textContent = data.recommendation || '';
            }
        })
        .catch(err => {
            console.error('Error getting recommended intensity:', err);
        });
}

// Generate Amazon search URL
function generateAmazonSearchUrl(productName) {
    // URL encode the product name for Amazon search
    const encodedName = encodeURIComponent(productName);
    // You can change the domain based on your region (amazon.com, amazon.co.uk, amazon.in, etc.)
    return `https://www.amazon.in/s?k=${encodedName}&ref=sr_pg_1`;
}

// Toggle vibration motor
function toggleVibration() {
    const newState = !vibrationMotorState;
    const command = newState ? 'on' : 'off';
    
    const btn = document.getElementById('vibrationBtn');
    const status = document.getElementById('vibrationStatus');
    const statusText = document.getElementById('vibrationStatusText');
    
    // Update UI immediately for better UX
    if (newState) {
        btn.classList.remove('bg-gray-200', 'text-gray-800');
        btn.classList.add('bg-green-500', 'text-white');
        status.textContent = 'ON';
        statusText.textContent = `Motor is turning ON at ${Math.round((currentIntensity / 255) * 100)}% intensity...`;
    } else {
        btn.classList.remove('bg-green-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-800');
        status.textContent = 'OFF';
        statusText.textContent = 'Motor is turning OFF...';
    }
    
    // Send command and intensity to ESP32
    const payload = {
        command: command,
        intensity: newState ? currentIntensity : null
    };
    
    fetch('/api/vibration', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            vibrationMotorState = newState;
            if (newState) {
                statusText.textContent = `Motor is ON at ${Math.round((currentIntensity / 255) * 100)}% intensity`;
            } else {
                statusText.textContent = 'Motor is OFF';
            }
            console.log(`Vibration motor: ${command}, Intensity: ${currentIntensity}`);
        } else {
            // Revert UI on error
            vibrationMotorState = !newState;
            if (vibrationMotorState) {
                btn.classList.remove('bg-gray-200', 'text-gray-800');
                btn.classList.add('bg-green-500', 'text-white');
                status.textContent = 'ON';
            } else {
                btn.classList.remove('bg-green-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
                status.textContent = 'OFF';
            }
            statusText.textContent = `Error: ${data.error || 'Failed to control motor'}`;
            console.error('Failed to control vibration motor:', data.error);
        }
    })
    .catch(err => {
        // Revert UI on error
        vibrationMotorState = !newState;
        if (vibrationMotorState) {
            btn.classList.remove('bg-gray-200', 'text-gray-800');
            btn.classList.add('bg-green-500', 'text-white');
            status.textContent = 'ON';
        } else {
            btn.classList.remove('bg-green-500', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-800');
            status.textContent = 'OFF';
        }
        statusText.textContent = `Error: ${err.message}`;
        console.error('Error controlling vibration motor:', err);
    });
}

// Initialize intensity slider display
updateIntensityDisplay(128);

// Load user ID on page load
fetch('/api/user-id')
    .then(res => res.json())
    .then(data => {
        if (data.user_id) {
            document.getElementById('userIdDisplay').textContent = data.user_id;
        }
    })
    .catch(err => console.error('Error loading user ID:', err));

// Age configuration functions
function openAgeConfig() {
    // Load current ages
    fetch('/api/age-config')
        .then(res => res.json())
        .then(ages => {
            document.getElementById('motherAge').value = ages.mother || '';
            document.getElementById('fatherAge').value = ages.father || '';
            document.getElementById('childAge').value = ages.child || '';
            document.getElementById('ageConfigModal').classList.remove('hidden');
        })
        .catch(err => {
            console.error('Error loading ages:', err);
            document.getElementById('ageConfigModal').classList.remove('hidden');
        });
}

function closeAgeConfig() {
    document.getElementById('ageConfigModal').classList.add('hidden');
}

function saveAges() {
    const ages = {
        mother: document.getElementById('motherAge').value || null,
        father: document.getElementById('fatherAge').value || null,
        child: document.getElementById('childAge').value || null
    };
    
    fetch('/api/age-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ages)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Ages saved successfully!');
            closeAgeConfig();
        } else {
            alert('Error: ' + (data.error || 'Failed to save ages'));
        }
    })
    .catch(err => {
        console.error('Error saving ages:', err);
        alert('Error saving ages. Please try again.');
    });
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    const modal = document.getElementById('ageConfigModal');
    if (e.target === modal) {
        closeAgeConfig();
    }
});

// Debug function to check database
function checkDebugData() {
    fetch('/api/debug-data')
        .then(res => res.json())
        .then(data => {
            console.log('=== Database Debug Info ===');
            console.log('Total records:', data.total_records);
            console.log('Roles found:', data.roles_found);
            console.log('Data by role:', data.data_by_role);
            alert(`Found ${data.total_records} total records.\nRoles: ${data.roles_found.join(', ') || 'none'}\nCheck console for details.`);
        })
        .catch(err => {
            console.error('Error checking debug data:', err);
            alert('Error checking database. See console for details.');
        });
}

// Auto-refresh sensor data every 5 seconds
setInterval(() => {
    if (selectedRole) {
        loadSensorData();
    }
}, 5000);
</script>
{% endblock %}

